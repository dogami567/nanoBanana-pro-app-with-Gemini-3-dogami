name: Build macOS App (Intel)

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘
    branches:
      - master  # å½“æ¨é€åˆ°masteråˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-macos-intel:
    # macos-12 ç›®å‰ä½¿ç”¨ Intel æ¶æ„ runnerï¼Œç”¨äºæ„å»º x86_64 ç‰ˆæœ¬
    runs-on: macos-12

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python (Intel)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_macos.txt

    - name: Build macOS App (Intel)
      run: |
        echo "Current directory: $(pwd)"
        echo "Available spec files:"
        ls -la *.spec || echo "No .spec files found"

        if [ -f "macos-release.spec" ]; then
          echo "âœ… Using macos-release.spec (Intel build)"
          pyinstaller macos-release.spec
        else
          echo "âš ï¸  macos-release.spec not found, using fallback"
          pyinstaller \
            --onedir \
            --windowed \
            --name "Nano-Banana" \
            --add-data "index.html:." \
            --add-data "script.js:." \
            --add-data "api.js:." \
            --add-data "utils.js:." \
            --add-data "styles.css:." \
            --osx-bundle-identifier "com.nanobanan.app" \
            app.py
        fi

    - name: Verify Intel build
      run: |
        ls -la dist/
        if [ -d "dist/Nano-Banana.app" ]; then
          echo "âœ… macOS Intel app built successfully"
          echo "App size: $(du -sh dist/Nano-Banana.app | cut -f1)"
          echo "Binary architectures:"
          file "dist/Nano-Banana.app/Contents/MacOS/Nano-Banana" || true
        else
          echo "âŒ Build failed - no .app found"
          exit 1
        fi

    - name: Create Intel DMG (macOS installer)
      run: |
        echo "Creating Intel DMG installer..."
        hdiutil create -volname "Nano Banana Intel" -srcfolder dist/ -ov -format UDZO "Nano-Banana-macOS-Intel.dmg" || echo "DMG creation failed, continuing without DMG"

        if [ -f "Nano-Banana-macOS-Intel.dmg" ]; then
          echo "âœ… Intel DMG created successfully"
          ls -la Nano-Banana-macOS-Intel.dmg
        else
          echo "âš ï¸  Intel DMG creation failed, will upload .app only"
        fi

    - name: Upload macOS Intel App as artifact
      uses: actions/upload-artifact@v4
      with:
        name: nano-banana-macos-intel
        path: |
          dist/Nano-Banana.app
          Nano-Banana-macOS-Intel.dmg
        retention-days: 30
        if-no-files-found: warn

    # ä»…åœ¨ tag push æ—¶å‘ Release ä¸­é™„åŠ  Intel ç‰ˆæœ¬
    - name: Attach Intel build to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          Nano-Banana-macOS-Intel.dmg
        name: "ğŸ Nano Banana ${{ github.ref_name }} - macOS Intel ç‰ˆæœ¬"
        body: |
          ## ğŸ macOS Intel ç‰ˆæœ¬

          é€‚ç”¨äº Intel èŠ¯ç‰‡çš„ Macï¼ˆä¾‹å¦‚ 2017 æ¬¾ MacBook Proï¼‰ã€‚

          ### ğŸ“¦ ä½¿ç”¨è¯´æ˜
          - ä¸‹è½½ `Nano-Banana-macOS-Intel.dmg`
          - åŒå‡»æŒ‚è½½åï¼Œå°† `Nano-Banana.app` æ‹–åˆ°ã€Œåº”ç”¨ç¨‹åºã€æ–‡ä»¶å¤¹
          - é¦–æ¬¡è¿è¡Œå¦‚æç¤ºæ¥è‡ªæœªè®¤è¯å¼€å‘è€…ï¼Œåœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸è¿è¡Œ

          ### â„¹ï¸ æ¶æ„è¯´æ˜
          - æœ¬ DMG ä¸º **x86_64ï¼ˆIntelï¼‰** ç‰ˆæœ¬
          - M ç³»åˆ— Apple Silicon å»ºè®®ä¼˜å…ˆä½¿ç”¨æ™®é€š `Nano-Banana-macOS.dmg`ï¼ˆarm64ï¼‰ç‰ˆæœ¬
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

