name: Build macOS App (Updated)

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘
    branches:
      - master  # å½“æ¨é€åˆ°masteråˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-15  # Use specific version for stability
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_macos.txt
        
    - name: Build macOS App
      run: |
        echo "Current directory: $(pwd)"
        echo "Available spec files:"
        ls -la *.spec || echo "No .spec files found"
        
        if [ -f "macos-release.spec" ]; then
          echo "âœ… Using macos-release.spec"
          pyinstaller macos-release.spec
        else
          echo "âš ï¸  macos-release.spec not found, using fallback"
          pyinstaller \
            --onedir \
            --windowed \
            --name "Nano-Banana" \
            --add-data "index.html:." \
            --add-data "script.js:." \
            --add-data "api.js:." \
            --add-data "utils.js:." \
            --add-data "styles.css:." \
            --osx-bundle-identifier "com.nanobanan.app" \
            app.py
        fi
          
    - name: Verify build
      run: |
        ls -la dist/
        if [ -d "dist/Nano-Banana.app" ]; then
          echo "âœ… macOS app built successfully"
          echo "App size: $(du -sh dist/Nano-Banana.app | cut -f1)"
        else
          echo "âŒ Build failed - no .app found"
          exit 1
        fi
        
    - name: Test app launch (basic check)
      run: |
        # Test if the app can be executed (basic validation)
        if [ -x "dist/Nano-Banana.app/Contents/MacOS/Nano-Banana" ]; then
          echo "âœ… App executable is valid"
        else
          echo "âŒ App executable not found or not executable"
          exit 1
        fi
        
    - name: Create DMG (macOS installer)
      run: |
        echo "Creating DMG installer..."
        # Simple DMG creation using hdiutil (built into macOS)
        hdiutil create -volname "Nano Banana" -srcfolder dist/ -ov -format UDZO "Nano-Banana-macOS.dmg" || echo "DMG creation failed, continuing without DMG"
        
        if [ -f "Nano-Banana-macOS.dmg" ]; then
          echo "âœ… DMG created successfully"
          ls -la Nano-Banana-macOS.dmg
        else
          echo "âš ï¸  DMG creation failed, will upload .app only"
        fi
        
    - name: Upload macOS App as artifact
      uses: actions/upload-artifact@v4
      with:
        name: nano-banana-macos
        path: |
          dist/Nano-Banana.app
          Nano-Banana-macOS.dmg
        retention-days: 30
        if-no-files-found: warn
        
    # Only create release if this is a tag push
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          Nano-Banana-macOS.dmg
        name: "ğŸŒ Nano Banana ${{ github.ref_name }} - macOSç‰ˆæœ¬"
        body: |
          ## ğŸ macOSç‰ˆæœ¬å‘å¸ƒ
          
          ### ğŸ“¦ ä¸‹è½½æ–¹å¼
          - ä¸‹è½½ `Nano-Banana-macOS.dmg`
          - åŒå‡»æ‰“å¼€ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          - é¦–æ¬¡è¿è¡Œéœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸
          
          ### ğŸ”‘ ä½¿ç”¨æ–¹æ³•
          1. è·å–Gemini API Key: https://ai.google.dev/
          2. å¯åŠ¨åº”ç”¨è¾“å…¥API Key
          3. ä¸Šä¼ å›¾ç‰‡å¼€å§‹ä½¿ç”¨
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - åŒå›¾åˆæˆå’Œå•å›¾å¢å¼º
          - æ‹–æ‹½ä¸Šä¼ å’Œå‰ªè´´æ¿ç²˜è´´
          - ç”Ÿæˆå†å²è®°å½•
          - æœ¬åœ°å¤„ç†ä¿æŠ¤éšç§
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
