name: Build macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_macos.txt
          pip install pyinstaller

      - name: Build macOS app
        run: |
          echo "Current directory: $(pwd)"
          echo "Looking for spec file..."
          ls -la *.spec || echo "No .spec files found"

          if [ -f "macos-release.spec" ]; then
            echo "âœ… Using macos-release.spec"
            pyinstaller macos-release.spec
          else
            echo "âš ï¸  macos-release.spec not found, building via CLI"
            pyinstaller \
              --onedir \
              --windowed \
              --name "Nano-Banana" \
              --add-data "index.html:." \
              --add-data "script.js:." \
              --add-data "api.js:." \
              --add-data "utils.js:." \
              --add-data "styles.css:." \
              --osx-bundle-identifier "com.nanobanan.app" \
              app.py
          fi

      - name: Verify build artifacts
        run: |
          ls -la dist/
          if [ -d "dist/Nano-Banana.app" ]; then
            echo "âœ… macOS app built successfully"
            echo "App size: $(du -sh dist/Nano-Banana.app | cut -f1)"
          else
            echo "âŒ Build failed - no .app found"
            exit 1
          fi

      - name: Test app binary presence
        run: |
          if [ -x "dist/Nano-Banana.app/Contents/MacOS/Nano-Banana" ]; then
            echo "âœ… App executable exists"
          else
            echo "âŒ App executable missing"
            exit 1
          fi

      - name: Create DMG installer
        run: |
          echo "Creating DMG installer..."
          hdiutil create -volname "Nano Banana" -srcfolder dist/ -ov -format UDZO "Nano-Banana-macOS.dmg" || echo "DMG creation failed, continuing without DMG"
          if [ -f "Nano-Banana-macOS.dmg" ]; then
            echo "âœ… DMG created successfully"
            ls -la Nano-Banana-macOS.dmg
          else
            echo "âš ï¸  DMG creation failed, will upload .app only"
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nano-banana-mac
          path: |
            dist/Nano-Banana.app
            Nano-Banana-macOS.dmg
          retention-days: 30
          if-no-files-found: warn

      - name: Publish Release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Nano-Banana-macOS.dmg
          name: "ğŸŒ Nano Banana ${{ github.ref_name }} - macOS ç‰ˆæœ¬"
          body: |
            ## ğŸ macOS ç‰ˆæœ¬å‘å¸ƒ
            - ä¸‹è½½ `Nano-Banana-macOS.dmg`
            - åŒå‡»å®‰è£…å¹¶æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åº
            - é¦–æ¬¡è¿è¡Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
